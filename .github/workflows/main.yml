name: "Main Pipeline"

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "**/*.md"
      - "docker-compose.yml"

jobs:
  terraform:
    name: "Provision infrastructure"
    uses: ./.github/workflows/job_terraform.yml
    secrets: inherit

  build:
    name: "Build and publish Docker image"
    needs: terraform
    uses: ./.github/workflows/job_build.yml
    with:
      acr_login_server: ${{ needs.terraform.outputs.acr_login_server }}
    secrets: inherit

  deploy:
    name: "Deploy to Azure"
    needs: [terraform, build]
    uses: ./.github/workflows/job_deploy.yml
    with:
      frontend_image_tag: ${{ needs.build.outputs.frontend_image_tag }}
      backend_image_tag: ${{ needs.build.outputs.backend_image_tag }}
      resource_group_name: ${{ needs.terraform.outputs.resource_group_name }}
      container_frontend_name: ${{ needs.terraform.outputs.container_frontend_name }}
      container_backend_name: ${{ needs.terraform.outputs.container_backend_name }}
    secrets: inherit
